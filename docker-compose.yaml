version: '3.9'
services:
    db: 
        image: mysql:8.0.32
        volumes:
            - ./backup.sh:/scripts/backup.sh
            - ./backup:/backup
            - ./db_volume:/var/lib/mysql
            - ./crontab:/etc/cron.d/crontab
        restart: always
        environment:
            MYSQL_ROOT_PASSWORD: password
            MYSQL_DATABASE: app
            MYSQL_USER: user
            MYSQL_PASSWORD: password
        networks:
            - backend
        healthcheck:
            test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost"]
            timeout: 20s
            retries: 10
    app:
        build: .
        command: sh -c "bundle exec rails db:migrate RAILS_ENV=development && bundle exec rails s -p 3000 -b '0.0.0.0'"
        volumes: 
            - .:/app
        depends_on:
            db:
                condition: service_healthy
        links:
            - db
        environment:
            DB_USER: root
            DB_NAME: app
            DB_PASSWORD: password
            DB_HOST: db
            DOCKERIZED: true
        networks:
            - backend
    nginx:
        image: nginx:latest
        volumes:
            - ./conf.d/nginx.conf:/etc/nginx/nginx.conf
        depends_on:
            - app
        ports:
            - 8081:80
        networks:
            - backend
networks:
    backend:
        external: false
